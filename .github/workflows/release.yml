name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: write
  packages: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run tests
        run: go test ./...

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest

  build:
    name: Build
    needs: [test, lint]
    strategy:
      matrix:
        include:
          # Windows builds
          - os: windows
            arch: amd64
            binary: mpdmon.exe
            suffix: .exe
          - os: windows
            arch: 386
            binary: mpdmon.exe
            suffix: .exe
          - os: windows
            arch: arm64
            binary: mpdmon.exe
            suffix: .exe
          # Linux builds
          - os: linux
            arch: amd64
            binary: mpdmon
            suffix: ''
          - os: linux
            arch: 386
            binary: mpdmon
            suffix: ''
          - os: linux
            arch: arm64
            binary: mpdmon
            suffix: ''
          - os: linux
            arch: arm
            binary: mpdmon
            suffix: ''
            goarm: 7
          # macOS builds
          - os: darwin
            arch: amd64
            binary: mpdmon
            suffix: ''
          - os: darwin
            arch: arm64
            binary: mpdmon
            suffix: ''
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Get dependencies
        run: go mod download

      - name: Build
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          GOARM: ${{ matrix.goarm || '' }}
        run: |
          # Get version from tag or commit
          VERSION="dev"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [[ "${{ github.ref }}" == refs/heads/master ]]; then
            VERSION="$(git rev-parse --short HEAD)"
          fi
          
          echo "Building version: $VERSION"
          
          go build \
            -ldflags="-s -w -X main.version=$VERSION" \
            -o mpdmon${{ matrix.suffix }} \
            .

      - name: Create archive (Windows)
        if: ${{ matrix.os == 'windows' }}
        run: |
          mkdir -p dist
          mv mpdmon.exe mpdmon-${{ matrix.os }}-${{ matrix.arch }}/
          cp README.md mpdmon-${{ matrix.os }}-${{ matrix.arch }}/
          cp LICENSE mpdmon-${{ matrix.os }}-${{ matrix.arch }}/
          
          cd mpdmon-${{ matrix.os }}-${{ matrix.arch }}
          zip -r ../dist/mpdmon-${{ matrix.os }}-${{ matrix.arch }}.zip .
          cd ..

      - name: Create archive (Unix-like)
        if: ${{ matrix.os != 'windows' }}
        run: |
          mkdir -p dist
          mv mpdmon mpdmon-${{ matrix.os }}-${{ matrix.arch }}/
          cp README.md mpdmon-${{ matrix.os }}-${{ matrix.arch }}/
          cp LICENSE mpdmon-${{ matrix.os }}-${{ matrix.arch }}/
          
          cd mpdmon-${{ matrix.os }}-${{ matrix.arch }}
          tar czf ../dist/mpdmon-${{ matrix.os }}-${{ matrix.arch }}.tar.gz .
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mpdmon-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            dist/mpdmon-${{ matrix.os }}-${{ matrix.arch }}.*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          find . -name "*.zip" -o -name "*.tar.gz" | while read file; do
            sha256sum "$file" | awk '{print $1, $2}' > "$file.sha256.txt"
          done
          
          # Create combined checksums file
          cat *.sha256.txt > checksums.txt

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            # MPD Monitor ${{ github.ref_name }}
            
            ## üì¶ Downloads
            
            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Windows | amd64 | [mpdmon-${{ github.ref_name }}-windows-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-windows-amd64.zip) |
            | Windows | 386 | [mpdmon-${{ github.ref_name }}-windows-386.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-windows-386.zip) |
            | Windows | arm64 | [mpdmon-${{ github.ref_name }}-windows-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-windows-arm64.zip) |
            | Linux | amd64 | [mpdmon-${{ github.ref_name }}-linux-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-linux-amd64.tar.gz) |
            | Linux | 386 | [mpdmon-${{ github.ref_name }}-linux-386.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-linux-386.tar.gz) |
            | Linux | arm64 | [mpdmon-${{ github.ref_name }}-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-linux-arm64.tar.gz) |
            | Linux | armv7 | [mpdmon-${{ github.ref_name }}-linux-arm.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-linux-arm.tar.gz) |
            | macOS | amd64 | [mpdmon-${{ github.ref_name }}-darwin-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-darwin-amd64.tar.gz) |
            | macOS | arm64 | [mpdmon-${{ github.ref_name }}-darwin-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-darwin-arm64.tar.gz) |
            
            ### üîê Verification
            
            SHA256 Checksums:
            
            ```bash
            $(cat artifacts/checksums.txt)
            ```
            
            ## üöÄ Features
            
            - Real-time MPD monitoring
            - GNTP/Growl notifications
            - Album art display
            - Cross-platform support
            - Configurable via config file or environment variables
            
            ## üìñ Quick Start
            
            ```bash
            # Download for your platform
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mpdmon-${{ github.ref_name }}-linux-amd64.tar.gz
            tar xzf mpdmon*.tar.gz
            ./mpdmon
            ```
            
            ## üîß Configuration
            
            See [README.md](https://github.com/${{ github.repository }}/blob/master/README.md) for detailed configuration options.
            
            ## üìÑ License
            
            MIT License
            
            ---
            
            *Built with GitHub Actions*
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
            artifacts/checksums.txt
          generate_release_notes: true

  docker:
    name: Build Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=ref,event=branch
            type=sha,prefix={{branch}}-,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64,linux/arm/v7

  publish-snap:
    name: Publish to Snapcraft
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Snapcraft
        uses: samuelmeuli/action-snapcraft@v2
        with:
          snapcraft_token: ${{ secrets.SNAPCRAFT_TOKEN }}

      - name: Build and publish snap
        run: snapcraft upload --release=stable *.snap

  nightly:
    name: Nightly Build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Build nightly
        run: |
          VERSION="nightly-$(git rev-parse --short HEAD)"
          GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.version=$VERSION" \
            -o mpdmon-nightly-linux-amd64 \
            .

      - name: Upload nightly artifact
        uses: actions/upload-artifact@v4
        with:
          name: mpdmon-nightly
          path: mpdmon-nightly-linux-amd64